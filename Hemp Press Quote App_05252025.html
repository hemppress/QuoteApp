<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8" />
  <title>Cost Calculator</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"     defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"             defer></script>

  <!-- Framer-motion -->
  <script src="https://unpkg.com/framer-motion@11/dist/framer-motion.umd.js" defer></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js" defer></script>
</head>
<body class="bg-slate-100 text-slate-800 dark:bg-slate-900 dark:text-slate-200">
  <div id="root" class="container mx-auto p-6"></div>

  <script type="text/babel">
/* ------------ SAFE MOTION ------------- */
const motion = window.framerMotion?.motion ?? { div: ({children,...p})=> <div {...p}>{children}</div> };

/* ============ CONSTANTS ============ */
const RATES = {
  QTY_PRESETS:[250,500,1000,3000,5000,10000,25000],

  PAPERS:[
    {id:'18pt', label:'18 pt — $1.09/PS', cost:1.09},
    {id:'10pt', label:'10 pt — $0.67/PS', cost:0.67},
    {id:'80txt',label:'80# Text — $0.40/PS', cost:0.40},
  ],

  PRINT_TIERS:{
    "1":[{min:1,max:499,price:0.85},{min:500,max:749,price:0.56},{min:750,max:999,price:0.46},{min:1000,max:2499,price:0.41},{min:2500,max:20000,price:0.32}],
    "2":[{min:1,max:499,price:1.13},{min:500,max:749,price:0.83},{min:750,max:999,price:0.73},{min:1000,max:2499,price:0.68},{min:2500,max:20000,price:0.59}],
  },

  DIE_MACHINES:{
    OG:{label:'OG Windmill – 0.04/pc', action:0.04, setup:60, stripping:0.01},
    GT:{label:'GT Windmill – 0.04/pc', action:0.04, setup:60, stripping:0.01},
    BRY:{label:'Barry – 0.12/pc',      action:0.12, setup:60, stripping:0.03},
  },

  GLUE_MACHINES:{
    HAND:{label:'Hand Glue', rates:{Fast:0.08,Slow:0.12,Complex:0.16}},
    MACHINE:{label:'Machine Glue', rates:{Standard:0.04,Complex:0.06}},
  },

  LOWEST_PRINT:{'1':0.32,'2':0.59},

  MARGINS:[0.60,0.50,0.40,0.30,0.25,0.15],
};

/* ========= UTILS ========= */
const ceil=Math.ceil;
const round2=n=>+(Math.round(n*100)/100).toFixed(2);
const tierPrice=(ps,side)=>RATES.PRINT_TIERS[side].find(t=>ps>=t.min&&ps<=t.max)?.price ?? RATES.PRINT_TIERS[side].at(-1).price;

/* ========== COST ENGINE ========== */
function compute(params){
  const over=1.10, effQty=params.qty*over;

  /* press-sheet & paper */
  const pressSheets=Math.max(5,ceil(effQty/params.OUT));
  const paperCost=pressSheets*params.paper.cost;

  /* printing cost per side (may be zero if printing disabled) */
  const printCostPS = params.includePrint ? (params.printOverride1Sided ?? tierPrice(pressSheets,'1')) : 0;
  const printCostPS2= params.includePrint ? (params.printOverride2Sided ?? tierPrice(pressSheets,'2')) : 0;
  const print1=pressSheets*printCostPS;
  const print2=pressSheets*printCostPS2;

  /* die */
  const dieM = RATES.DIE_MACHINES[params.die.machine];
  const action = params.die.customAction??dieM.action;
  const setup  = params.die.customSetup ??dieM.setup;
  const stripPerPc = dieM.stripping + params.windows*0.015;
  const dieVar = params.includeDie ? effQty*((action/params.UP)+stripPerPc) : 0;
  const dieCost = params.includeDie ? dieVar + setup : 0;

  /* glue */
  let glueRate=0, glueCostMarkup=0, glueCostEx=0;
  if(params.glue.include){
    glueRate = RATES.GLUE_MACHINES[params.glue.machine].rates[params.glue.mode];
    const glueTotal = glueRate*effQty;
    if(params.glue.machine==='HAND' && params.glue.atCost){
      glueCostMarkup = Math.min(0.04*effQty, glueTotal);
      glueCostEx     = glueTotal - glueCostMarkup;
    }else glueCostMarkup = glueTotal;
  }

  /* pre-press */
  let preCost = 0;
  if (params.includePrepress) {
    if (params.prepressOverrideCost !== null) { // baseParams ensures empty string '' becomes null
      preCost = params.prepressOverrideCost; 
    } else {
      preCost = 65 + Math.max(0, params.SKUs - 1) * 35;
    }
  }

  /* handling */
  const handlingRate = params.includeHandling ? (params.handleOverride!==''?+params.handleOverride:(params.OUT<=5?0.02:0)) : 0;
  const handlingCost = handlingRate*params.qty;

  /* margin logic */
  const margin = params.useMargin?params.margin:0;

  /* Custom Cost Calculation */
  let totalCustomCost = 0;
  if (params.includeCustomCost && params.customCostValue > 0) {
    if (params.customCostType === 'perPiece') {
      totalCustomCost = params.customCostValue * params.qty; 
    } else { // oneTime
      totalCustomCost = params.customCostValue; 
    }
  }

  function sideTotals(printCostSide){
    const markupBase = (params.paperAtCost?0:paperCost) + printCostSide + dieCost + glueCostMarkup + totalCustomCost; 
    const excluded   = (params.paperAtCost?paperCost:0)+glueCostEx+preCost+handlingCost;
    const sellPcRaw  = (markupBase/(1-margin)+excluded)/params.qty;
    const sellPc     = round2(sellPcRaw);
    const sellTotal  = round2(sellPc*params.qty);

    const costBreak={
      paper:paperCost/params.qty,
      print:printCostSide/params.qty,
      die:dieCost/params.qty,
      strip:params.windows?stripPerPc:0,
      glue:(glueCostMarkup+glueCostEx)/params.qty,
      pre:preCost/params.qty,
      handling:handlingCost/params.qty
    };

    if (params.includeCustomCost && params.customCostValue > 0) {
      const keyForCustomCost = params.customCostName || 'Custom Cost';
      costBreak[keyForCustomCost] = totalCustomCost / params.qty;
    }
    
    return {sellPc,sellTotal,costBreak};
  }

  return {pressSheets,
          one:sideTotals(print1),
          two:sideTotals(print2),
          addOn:round2(sideTotals(print2).sellPc - sideTotals(print1).sellPc)};
}

/* ====== BEST-PRICE notched to 100 ====== */
function bestBreaks(OUT){
  const set=new Set();
  ['1','2'].forEach(s=>{
    RATES.PRINT_TIERS[s].slice(1).forEach(t=>{
      const pcs=ceil((t.min*OUT)/1.10/100)*100; 
      set.add(pcs);
    });
  });
  return [...set].sort((a,b)=>a-b);
}

/* ===== Components ===== */
const Label=({children})=><label className="flex flex-col gap-1 text-sm">{children}</label>;
const Num = props=><input type="number" className="border rounded px-2 py-1 w-full" {...props}/>;

/* =========== APP =========== */
function App(){
  /* STATE */
  const [darkMode, setDarkMode] = React.useState(false);
  const [quantities,setQuantities]=React.useState(RATES.QTY_PRESETS.map(q => ({ value: q, active: true, isDefault: true })));
  const [customQty,setCustomQty]=React.useState('');

  React.useEffect(() => {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      setDarkMode(true);
      // It's important that the classes are applied here too,
      // not just relying on the other useEffect, to prevent flicker.
      document.documentElement.classList.add('dark');
      document.body.classList.add('dark');
    } else {
      setDarkMode(false); 
      // Ensure classes are removed if the saved theme is light or not present
      document.documentElement.classList.remove('dark');
      document.body.classList.remove('dark');
    }
  }, []); 

  React.useEffect(() => {
    if (darkMode) {
      document.documentElement.classList.add('dark');
      document.body.classList.add('dark'); // Add this line
      localStorage.setItem('theme', 'dark');
    } else {
      document.documentElement.classList.remove('dark');
      document.body.classList.remove('dark'); // Add this line
      localStorage.setItem('theme', 'light');
    }
  }, [darkMode]); 

  const [UP,setUP]=React.useState(1);
  const [OUT,setOUT]=React.useState(1);

  const [papers,setPapers]=React.useState([...RATES.PAPERS]);
  const [paperIdx,setPaperIdx]=React.useState(0);
  const [paperAtCost,setPaperAtCost]=React.useState(false);
  const [customPaperName, setCustomPaperName] = React.useState('');
  const [customPaperPrice, setCustomPaperPrice] = React.useState('');

  /* Printing */
  const [includePrint,setIncludePrint]=React.useState(true);
  const [printOverride1Sided,setPrintOverride1Sided]=React.useState('');
  const [printOverride2Sided,setPrintOverride2Sided]=React.useState('');

  /* Die */
  const [includeDie,setIncludeDie]=React.useState(true);
  const [dieMachine,setDieMachine]=React.useState('OG');
  const [windows,setWindows]=React.useState(0);
  const [dieSetupOverride,setDieSetupOverride]=React.useState('');
  const [dieActionOverride,setDieActionOverride]=React.useState('');

  /* Glue */
  const [glueInclude,setGlueInclude]=React.useState(false);
  const [glueMachine,setGlueMachine]=React.useState('HAND');
  const [glueMode,setGlueMode]=React.useState('Fast');
  const [glueAtCost,setGlueAtCost]=React.useState(false);

  /* Pre-press & margin */
  const [SKUs,setSKUs]=React.useState(1);
  const [includePrepress, setIncludePrepress] = React.useState(true);
  const [prepressOverrideCost, setPrepressOverrideCost] = React.useState('');
  const [useMargin,setUseMargin]=React.useState(true);
  const [marginPreset,setMarginPreset]=React.useState('0.60');
  const [marginCustom,setMarginCustom]=React.useState('');

  /* Handling */
  const [includeHandling,setIncludeHandling]=React.useState(true);
  const [handleOverride,setHandleOverride]=React.useState('');

  /* Custom Cost Add-On */
  const [includeCustomCost, setIncludeCustomCost] = React.useState(false);
  const [customCostName, setCustomCostNameState] = React.useState(''); 
  const [customCostValue, setCustomCostValueState] = React.useState(''); 
  const [customCostType, setCustomCostType] = React.useState('perPiece'); 


  const handleAddCustomPaper = () => {
    if (customPaperName && customPaperPrice) {
      const newPaperCost = parseFloat(customPaperPrice);
      if (isNaN(newPaperCost)) {
        alert('Please enter a valid price for the custom paper.');
        return;
      }
      const newPaper = {
        id: customPaperName.toLowerCase().replace(/\s+/g, '-'),
        label: `${customPaperName} — $${newPaperCost.toFixed(2)}/PS`,
        cost: newPaperCost
      };
      setPapers(prevPapers => {
        const updatedPapers = [...prevPapers, newPaper];
        setPaperIdx(updatedPapers.length - 1); 
        return updatedPapers;
      });
      setCustomPaperName('');
      setCustomPaperPrice('');
    } else {
      alert('Please enter both name and price for the custom paper.');
    }
  };

  /* PARAMS helper */
  const baseParams=q=>({
    qty:q,
    UP:+UP||1,
    OUT:+OUT||1,
    paper:papers[paperIdx],
    paperAtCost,
    includePrint,
    printOverride1Sided:printOverride1Sided?+printOverride1Sided:null,
    printOverride2Sided:printOverride2Sided?+printOverride2Sided:null,
    includeDie,
    die:{
      machine:dieMachine,
      customSetup:dieSetupOverride?+dieSetupOverride:null,
      customAction:dieActionOverride?+dieActionOverride:null
    },
    windows:+windows||0,
    glue:{
      include:glueInclude,
      machine:glueMachine,
      mode:glueMode,
      atCost:glueAtCost
    },
    SKUs:+SKUs||1,
    includePrepress: includePrepress,
    prepressOverrideCost: prepressOverrideCost !== '' ? +prepressOverrideCost : null, // Ensure empty string becomes null
    useMargin,
    // margin:+(marginCustom||marginPreset), // This is the old line
    // New margin logic:
    margin: (() => {
      let effectiveMargin = 0;
      if (marginCustom) { // If custom margin input has a value
        effectiveMargin = +marginCustom / 100;
      } else {
        effectiveMargin = +marginPreset;
      }
      // Cap the margin at 0.99 (99%)
      return Math.min(effectiveMargin, 0.99);
    })(),
    includeHandling,
    handleOverride,
    includeCustomCost: includeCustomCost,
    customCostName: customCostName, 
    customCostValue: customCostValue ? +customCostValue : 0, 
    customCostType: customCostType,
  });

  /* COPY-TABLE makers */
  const fmtLines=(side)=>quantities
    .filter(qObj => qObj.active)
    .map(qObj => `${qObj.value.toLocaleString().padEnd(7,' ')} ........... $${compute(baseParams(qObj.value))[side].sellPc.toFixed(2)}`)
    .join('\n');

  /* BEST PRICE lines */
  const bestQs=bestBreaks(OUT);
  const bestLines=(side)=>bestQs.map(q=>`${q.toLocaleString().padEnd(7,' ')} ........... $${compute(baseParams(q))[side].sellPc.toFixed(2)}`).join('\n');

  /* LOW COST tables (force lowest tier) */
  const lowLines=(side)=>quantities
    .filter(qObj => qObj.active)
    .map(qObj =>{
      const p = baseParams(qObj.value);
      if (side === 'one') {
        p.printOverride1Sided = RATES.LOWEST_PRINT['1'];
        // For a 1-sided low-cost quote, the second side's printing cost should effectively be zero.
        // Setting printOverride2Sided = 0 ensures that print2 in compute() becomes 0 if includePrint is true.
        p.printOverride2Sided = 0; 
      } else { // side === 'two'
        p.printOverride1Sided = RATES.LOWEST_PRINT['1'];
        p.printOverride2Sided = RATES.LOWEST_PRINT['2'];
      }
      return `${qObj.value.toLocaleString().padEnd(7,' ')} ........... $${compute(p)[side].sellPc.toFixed(2)}`;
    }).join('\n');

  /* UI */
  return(
    <>
      <button
        onClick={() => setDarkMode(!darkMode)}
        className="fixed top-4 right-4 z-50 px-3 py-2 rounded-md text-sm font-medium bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 shadow"
        aria-label="Toggle light and dark mode"
      >
        {darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
      </button>
      <div className="grid md:grid-cols-2 gap-8">
        {/* ===== COSTING ===== */}
        <div className="space-y-6">
        <h1 className="text-2xl font-bold">Custom Costing</h1>

        {/* Quantities */}
        <section className="bg-white p-4 rounded-xl shadow space-y-3">
          <h2 className="font-semibold">Order Quantities (Click the numbers to toggle on/off)</h2>
          <div className="flex flex-wrap gap-2">
            {quantities.sort((a, b) => a.value - b.value).map(qObj => (
              <button 
                key={qObj.value} 
                className={`px-3 py-1 rounded hover:bg-slate-300 ${qObj.active ? 'bg-indigo-500 text-white hover:bg-indigo-600' : 'bg-slate-200'}`}
                onClick={() => setQuantities(prevQuantities => 
                  prevQuantities.map(item => 
                    item.value === qObj.value ? { ...item, active: !item.active } : item
                  )
                )}
              >
                {qObj.value.toLocaleString()}
              </button>
            ))}
          </div>
          <div className="flex gap-2">
            <Num value={customQty} onChange={e=>setCustomQty(e.target.value)} placeholder="Enter custom qty"/>
            <button 
              className="px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600" 
              onClick={() => {
                if (customQty) {
                  const numQty = +customQty;
                  setQuantities(prevQs => {
                    const existingQty = prevQs.find(q => q.value === numQty);
                    if (existingQty) {
                      return prevQs.map(q => q.value === numQty ? { ...q, active: true } : q);
                    } else {
                      return [...prevQs, { value: numQty, active: true, isDefault: false }].sort((a,b) => a.value - b.value);
                    }
                  });
                  setCustomQty('');
                }
              }}
            >
              Add
            </button>
          </div>
        </section>

        {/* Layout */}
        <section className="bg-white p-4 rounded-xl shadow">
          <h2 className="font-semibold mb-2">Piece layout</h2>
          <div className="grid grid-cols-2 gap-4">
            <Label>UP (Units per Cut Sheet)<Num value={UP} onChange={e=>setUP(e.target.value)}/></Label>
            <Label>OUT(Units Per Press Sheet)<Num value={OUT} onChange={e=>setOUT(e.target.value)}/></Label>
          </div>
        </section>

        {/* Paper */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <h2 className="font-semibold">Paper</h2>
          <select className="w-full border rounded px-2 py-1" value={paperIdx} onChange={e=>setPaperIdx(+e.target.value)}>
            {papers.map((p,i)=><option key={p.id} value={i}>{p.label}</option>)}
          </select>
          <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={paperAtCost} onChange={e=>setPaperAtCost(e.target.checked)}/>Add paper at cost (exclude markup)</label>
          <div className="mt-4 space-y-2">
            <h3 className="font-semibold text-sm">Add Custom Paper</h3>
            <Label>Paper Name
              <input type="text" value={customPaperName} onChange={e => setCustomPaperName(e.target.value)} className="border rounded px-2 py-1 w-full" />
            </Label>
            <Label>Price per Press Sheet
              <Num value={customPaperPrice} onChange={e => setCustomPaperPrice(e.target.value)} />
            </Label>
            <button
              onClick={handleAddCustomPaper}
              className="px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600 text-sm"
            >
              Add Custom Paper
            </button>
          </div>
        </section>

        {/* Printing */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <label className="flex items-center gap-2 font-semibold"><input type="checkbox" checked={includePrint} onChange={e=>setIncludePrint(e.target.checked)}/>Include printing</label>
          {includePrint&&<>
            <Label>Override cost / Press-Sheet – 1 Sided <Num value={printOverride1Sided} onChange={e=>setPrintOverride1Sided(e.target.value)}/></Label>
            <Label>Override cost / Press-Sheet – 2 Sided <Num value={printOverride2Sided} onChange={e=>setPrintOverride2Sided(e.target.value)}/></Label>
          </>}
        </section>

        {/* Die */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <label className="flex items-center gap-2 font-semibold"><input type="checkbox" checked={includeDie} onChange={e=>setIncludeDie(e.target.checked)}/>Include die-cutting</label>
          {includeDie&&<>
            <Label>Select Machine
              <select className="border rounded px-2 py-1" value={dieMachine} onChange={e=>setDieMachine(e.target.value)}>
                {Object.entries(RATES.DIE_MACHINES).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
              </select>
            </Label>
            <Label>Custom setup $/job<Num value={dieSetupOverride} onChange={e=>setDieSetupOverride(e.target.value)}/></Label>
            <Label>Custom action $/pc<Num value={dieActionOverride} onChange={e=>setDieActionOverride(e.target.value)}/></Label>
            <Label>Windows / piece<Num value={windows} min={0} onChange={e=>setWindows(e.target.value)}/></Label>
          </>}
        </section>

        {/* Glue */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <label className="flex items-center gap-2 font-semibold"><input type="checkbox" checked={glueInclude} onChange={e=>setGlueInclude(e.target.checked)}/>Include glue</label>
          {glueInclude&&<>
            <Label>Machine
              <select className="border rounded px-2 py-1" value={glueMachine} onChange={e=>{setGlueMachine(e.target.value);setGlueMode(Object.keys(RATES.GLUE_MACHINES[e.target.value].rates)[0])}}>
                {Object.entries(RATES.GLUE_MACHINES).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
              </select>
            </Label>
            <Label>Mode / rate
              <select className="border rounded px-2 py-1" value={glueMode} onChange={e=>setGlueMode(e.target.value)}>
                {Object.entries(RATES.GLUE_MACHINES[glueMachine].rates).map(([m,r])=><option key={m} value={m}>{m} – ${r.toFixed(2)}/pc</option>)}
              </select>
            </Label>
            {glueMachine==='HAND'&&<label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={glueAtCost} onChange={e=>setGlueAtCost(e.target.checked)}/>Add glue at cost (first $0.04 in markup)</label>}
          </>}
        </section>
        
        {/* Handling */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <label className="flex items-center gap-2 font-semibold"><input type="checkbox" checked={includeHandling} onChange={e=>setIncludeHandling(e.target.checked)}/>Include handling</label>
          {includeHandling&&<Label>Cost / piece<Num value={handleOverride} onChange={e=>setHandleOverride(e.target.value)}/></Label>}
          <p className="text-xs text-slate-500">Default $0.02 / pc when OUT ≤ 5</p>
        </section>

        {/* Custom Cost Section */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <label className="flex items-center gap-2 font-semibold">
            <input type="checkbox" checked={includeCustomCost} onChange={e => setIncludeCustomCost(e.target.checked)} />
            Enable Custom Cost
          </label>
          {includeCustomCost && (
            <div className="space-y-2 pt-2">
              <Label>Custom Name
                <input 
                  type="text" 
                  value={customCostName} 
                  onChange={e => setCustomCostNameState(e.target.value)} 
                  placeholder="e.g., Packing Fee" 
                  className="border rounded px-2 py-1 w-full" 
                />
              </Label>
              <Label>Custom Cost Value
                <Num value={customCostValue} onChange={e => setCustomCostValueState(e.target.value)} />
              </Label>
              <div className="flex gap-4 text-sm">
                <label className="flex items-center gap-1">
                  <input 
                    type="radio" 
                    name="customCostType" 
                    value="perPiece" 
                    checked={customCostType === 'perPiece'} 
                    onChange={() => setCustomCostType('perPiece')} 
                  /> Per Piece
                </label>
                <label className="flex items-center gap-1">
                  <input 
                    type="radio" 
                    name="customCostType" 
                    value="oneTime" 
                    checked={customCostType === 'oneTime'} 
                    onChange={() => setCustomCostType('oneTime')} 
                  /> One-Time (per order)
                </label>
              </div>
            </div>
          )}
        </section>

        {/* Pre-press */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <h2 className="font-semibold">Pre-press / proofing</h2>
          <label className="flex items-center gap-2 font-semibold">
            <input type="checkbox" checked={includePrepress} onChange={e => setIncludePrepress(e.target.checked)} />
            Include Pre-press / Proofing
          </label>
          {includePrepress && (
            <>
              <Label>Override Pre-press Cost ($)
                <Num value={prepressOverrideCost} onChange={e => setPrepressOverrideCost(e.target.value)} placeholder="e.g., 100" />
              </Label>
              <Label># of SKUs (used if override is not set)
                <Num value={SKUs} min={1} onChange={e=>setSKUs(e.target.value)}/>
              </Label>
              <p className="text-xs text-slate-500">Original logic: Base $65 + $35 per extra SKU. If override is set, SKU count is ignored for pre-press cost.</p>
            </>
          )}
        </section>

        {/* Margin */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <label className="flex items-center gap-2 font-semibold"><input type="checkbox" checked={useMargin} onChange={e=>setUseMargin(e.target.checked)}/>Include margin</label>
          {useMargin&&<>
            <select className="w-full border rounded px-2 py-1" value={marginPreset} onChange={e=>setMarginPreset(e.target.value)}>
              {RATES.MARGINS.map(m=><option key={m} value={m}>{(m*100).toFixed(0)}%</option>)}
            </select>
            <Label>Custom %<Num value={marginCustom} onChange={e=>setMarginCustom(e.target.value)}/></Label>
          </>}
        </section>

      </div>

      {/* ===== PRICING ===== */}
      <div className="space-y-6">
        <h1 className="text-2xl font-bold">Custom Pricing</h1>

        {quantities.filter(qObj => qObj.active).map(qObj => { 
          const q = qObj.value;
          const res=compute(baseParams(q));
          const {one,two,addOn}=res; 
          
          const totalCostPerPieceOne = Object.values(res.one.costBreak).reduce((a, b) => a + b, 0);
          const costBreakdownStringOne = Object.entries(res.one.costBreak)
            .filter(([key, value]) => value > 0.000001) 
            .map(([key, value]) => `${key.charAt(0).toUpperCase() + key.slice(1)}: $${value.toFixed(4)}`)
            .join(' + ');

          let percentageBreakdownStringOne = '';
          if (totalCostPerPieceOne > 0) {
            const costPercentagesOne = Object.entries(res.one.costBreak)
              .filter(([key, value]) => value > 0.000001) 
              .map(([key, value]) => ({
                name: key.charAt(0).toUpperCase() + key.slice(1),
                percentage: (value / totalCostPerPieceOne) * 100,
              }))
              .sort((a, b) => b.percentage - a.percentage); 

            percentageBreakdownStringOne = costPercentagesOne
              .map(item => `${item.name}: ${item.percentage.toFixed(1)}%`)
              .join(' + ');
          }
          
          return(
            <motion.div key={q} className="bg-white p-6 rounded-xl shadow space-y-2" initial={{opacity:0,y:20}} animate={{opacity:1,y:0}}>
              <h3 className="text-lg font-semibold">{q.toLocaleString()} pcs</h3>
              <table className="w-full text-sm mb-1">
                <thead><tr className="text-left"><th></th><th>$ / pc</th><th>Total</th></tr></thead>
                <tbody>
                  <tr><td>1-Sided</td><td>${res.one.sellPc.toFixed(2)}</td><td>${res.one.sellTotal.toFixed(2)}</td></tr>
                  <tr><td>2-Sided</td><td>${res.two.sellPc.toFixed(2)}</td><td>${res.two.sellTotal.toFixed(2)}</td></tr>
                </tbody>
              </table>
              <p className="text-sm">2-Sided add-on: +${addOn.toFixed(2)} / pc</p>
              <p className="text-xs text-slate-500">Press-sheets incl. overage: {res.pressSheets}</p>
              <p className="text-xs text-slate-500">
                Costs / pc (1-Sided): {costBreakdownStringOne} = ${totalCostPerPieceOne.toFixed(4)}
              </p>
              {percentageBreakdownStringOne && (
              <p className="text-xs text-slate-500 mt-1">
                Contribution: {percentageBreakdownStringOne}
              </p>
            )}
            </motion.div>
          );
        })}

        {/* COPY BLOCKS */}
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <h2 className="font-semibold mb-1">Pricing table 1-Sided</h2>
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:fmtLines('one').replace(/\n/g,'<br/>')}}></div>
          </div>
          <div>
            <h2 className="font-semibold mb-1">Pricing table 2-Sided</h2>
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:fmtLines('two').replace(/\n/g,'<br/>')}}></div>
          </div>
        </div>

        {/* BEST-PRICE */}
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <h2 className="font-semibold mb-1">Best-price quantities 1-Sided</h2>
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:bestLines('one').replace(/\n/g,'<br/>')}}></div>
          </div>
          <div>
            <h2 className="font-semibold mb-1">Best-price quantities 2-Sided</h2>
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:bestLines('two').replace(/\n/g,'<br/>')}}></div>
          </div>
        </div>

        {/* LOW COST */}
        <div>
          <h2 className="font-semibold mb-1">Low Cost Printing Pricing</h2>
          <div className="grid md:grid-cols-2 gap-4">
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:lowLines('one').replace(/\n/g,'<br/>')}}></div>
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:lowLines('two').replace(/\n/g,'<br/>')}}></div>
          </div>
        </div>
      </div>
    </div>
    </>
  );
}

/* ===== MOUNT ===== */
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>

  <!-- ===================================================
    // Edit RATES to tweak tiers, machines, or low-cost values.
    // Core math lives in compute(); best-break logic in bestBreaks().
  =================================================== -->
</body>
</html>
