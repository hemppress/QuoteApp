<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cost Calculator</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"     defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"             defer></script>

  <!-- Framer-motion -->
  <script src="https://unpkg.com/framer-motion@11/dist/framer-motion.umd.js" defer></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js" defer></script>
</head>
<body class="bg-slate-100 text-slate-800">
  <div id="root" class="container mx-auto p-6"></div>

  <script type="text/babel">
/* ------------ SAFE MOTION ------------- */
const motion = window.framerMotion?.motion ?? { div: ({children,...p})=> <div {...p}>{children}</div> };

/* ============ CONSTANTS ============ */
const RATES = {
  QTY_PRESETS:[250,500,1000,3000,5000,10000,25000],

  PAPERS:[
    {id:'18pt', label:'18 pt — $1.09/PS', cost:1.09},
    {id:'10pt', label:'10 pt — $0.67/PS', cost:0.67},
    {id:'80txt',label:'80# Text — $0.40/PS', cost:0.40},
  ],

  PRINT_TIERS:{
    "1":[{min:1,max:499,price:0.85},{min:500,max:749,price:0.56},{min:750,max:999,price:0.46},{min:1000,max:2499,price:0.41},{min:2500,max:20000,price:0.32}],
    "2":[{min:1,max:499,price:1.13},{min:500,max:749,price:0.83},{min:750,max:999,price:0.73},{min:1000,max:2499,price:0.68},{min:2500,max:20000,price:0.59}],
  },

  DIE_MACHINES:{
    OG:{label:'OG Windmill – 0.04/pc', action:0.04, setup:60, stripping:0.01},
    GT:{label:'GT Windmill – 0.04/pc', action:0.04, setup:60, stripping:0.01},
    BRY:{label:'Barry – 0.12/pc',      action:0.12, setup:60, stripping:0.03},
  },

  GLUE_MACHINES:{
    HAND:{label:'Hand Glue', rates:{Fast:0.08,Slow:0.12,Complex:0.16}},
    MACHINE:{label:'Machine Glue', rates:{Standard:0.04,Complex:0.06}},
  },

  LOWEST_PRINT:{'1':0.32,'2':0.59},

  MARGINS:[0.60,0.50,0.40,0.30,0.25,0.15],
};

/* ========= UTILS ========= */
const ceil=Math.ceil;
const round2=n=>+(Math.round(n*100)/100).toFixed(2);
const tierPrice=(ps,side)=>RATES.PRINT_TIERS[side].find(t=>ps>=t.min&&ps<=t.max)?.price ?? RATES.PRINT_TIERS[side].at(-1).price;

/* ========== COST ENGINE ========== */
function compute(params){
  const over=1.10, effQty=params.qty*over;

  /* press-sheet & paper */
  const pressSheets=Math.max(5,ceil(effQty/params.OUT));
  const paperCost=pressSheets*params.paper.cost;

  /* printing cost per side (may be zero if printing disabled) */
  const printCostPS = params.includePrint ? (params.printOverride ?? tierPrice(pressSheets,'1')) : 0;
  const printCostPS2= params.includePrint ? (params.printOverride ?? tierPrice(pressSheets,'2')) : 0;
  const print1=pressSheets*printCostPS;
  const print2=pressSheets*printCostPS2;

  /* die */
  const dieM = RATES.DIE_MACHINES[params.die.machine];
  const action = params.die.customAction??dieM.action;
  const setup  = params.die.customSetup ??dieM.setup;
  const stripPerPc = dieM.stripping + params.windows*0.015;
  const dieVar = params.includeDie ? effQty*((action/params.UP)+stripPerPc) : 0;
  const dieCost = params.includeDie ? dieVar + setup : 0;

  /* glue */
  let glueRate=0, glueCostMarkup=0, glueCostEx=0;
  if(params.glue.include){
    glueRate = RATES.GLUE_MACHINES[params.glue.machine].rates[params.glue.mode];
    const glueTotal = glueRate*effQty;
    if(params.glue.machine==='HAND' && params.glue.atCost){
      glueCostMarkup = Math.min(0.04*effQty, glueTotal);
      glueCostEx     = glueTotal - glueCostMarkup;
    }else glueCostMarkup = glueTotal;
  }

  /* pre-press (always outside markup) */
  const preCost = 65 + Math.max(0,params.SKUs-1)*35;

  /* handling */
  const handlingRate = params.includeHandling ? (params.handleOverride!==''?+params.handleOverride:(params.OUT<=5?0.02:0)) : 0;
  const handlingCost = handlingRate*params.qty;

  /* margin logic */
  const margin = params.useMargin?params.margin:0;

  function sideTotals(printCost){
    const markupBase = (params.paperAtCost?0:paperCost)+printCost+dieCost+glueCostMarkup;
    const excluded   = (params.paperAtCost?paperCost:0)+glueCostEx+preCost+handlingCost;
    const sellPcRaw  = (markupBase/(1-margin)+excluded)/params.qty;
    const sellPc     = round2(sellPcRaw);
    const sellTotal  = round2(sellPc*params.qty);

    const costBreak={
      paper:paperCost/params.qty,
      print:printCost/params.qty,
      die:dieCost/params.qty,
      strip:params.windows?stripPerPc:0,
      glue:(glueCostMarkup+glueCostEx)/params.qty,
      pre:preCost/params.qty,
      handling:handlingCost/params.qty
    };

    return {sellPc,sellTotal,costBreak};
  }

  return {pressSheets,
          one:sideTotals(print1),
          two:sideTotals(print2),
          addOn:round2(sideTotals(print2).sellPc - sideTotals(print1).sellPc)};
}

/* ====== BEST-PRICE notched to 100 ====== */
function bestBreaks(OUT){
  const set=new Set();
  ['1','2'].forEach(s=>{
    RATES.PRINT_TIERS[s].slice(1).forEach(t=>{
      const pcs=ceil((t.min*OUT)/1.10/100)*100; // next 100
      set.add(pcs);
    });
  });
  return [...set].sort((a,b)=>a-b);
}

/* ===== Components ===== */
const Label=({children})=><label className="flex flex-col gap-1 text-sm">{children}</label>;
const Num = props=><input type="number" className="border rounded px-2 py-1 w-full" {...props}/>;

/* =========== APP =========== */
function App(){
  /* STATE */
  const [quantities,setQuantities]=React.useState([...RATES.QTY_PRESETS]);
  const [customQty,setCustomQty]=React.useState('');

  const [UP,setUP]=React.useState(1);
  const [OUT,setOUT]=React.useState(1);

  const [papers,setPapers]=React.useState([...RATES.PAPERS]);
  const [paperIdx,setPaperIdx]=React.useState(0);
  const [paperAtCost,setPaperAtCost]=React.useState(false);

  /* Printing */
  const [includePrint,setIncludePrint]=React.useState(true);
  const [printOverride,setPrintOverride]=React.useState('');

  /* Die */
  const [includeDie,setIncludeDie]=React.useState(true);
  const [dieMachine,setDieMachine]=React.useState('OG');
  const [windows,setWindows]=React.useState(0);
  const [dieSetupOverride,setDieSetupOverride]=React.useState('');
  const [dieActionOverride,setDieActionOverride]=React.useState('');

  /* Glue */
  const [glueInclude,setGlueInclude]=React.useState(false);
  const [glueMachine,setGlueMachine]=React.useState('HAND');
  const [glueMode,setGlueMode]=React.useState('Fast');
  const [glueAtCost,setGlueAtCost]=React.useState(false);

  /* Pre-press & margin */
  const [SKUs,setSKUs]=React.useState(1);
  const [useMargin,setUseMargin]=React.useState(true);
  const [marginPreset,setMarginPreset]=React.useState('0.60');
  const [marginCustom,setMarginCustom]=React.useState('');

  /* Handling */
  const [includeHandling,setIncludeHandling]=React.useState(true);
  const [handleOverride,setHandleOverride]=React.useState('');

  /* PARAMS helper */
  const baseParams=q=>({
    qty:q,
    UP:+UP||1,
    OUT:+OUT||1,
    paper:papers[paperIdx],
    paperAtCost,
    includePrint,
    printOverride:printOverride?+printOverride:null,
    includeDie,
    die:{
      machine:dieMachine,
      customSetup:dieSetupOverride?+dieSetupOverride:null,
      customAction:dieActionOverride?+dieActionOverride:null
    },
    windows:+windows||0,
    glue:{
      include:glueInclude,
      machine:glueMachine,
      mode:glueMode,
      atCost:glueAtCost
    },
    SKUs:+SKUs||1,
    useMargin,
    margin:+(marginCustom||marginPreset),
    includeHandling,
    handleOverride,
  });

  /* COPY-TABLE makers */
  const fmtLines=(side)=>quantities.map(q=>`${q.toLocaleString().padEnd(7,' ')} ........... $${compute(baseParams(q))[side].sellPc.toFixed(2)}`).join('\n');

  /* BEST PRICE lines */
  const bestQs=bestBreaks(OUT);
  const bestLines=(side)=>bestQs.map(q=>`${q.toLocaleString().padEnd(7,' ')} ........... $${compute(baseParams(q))[side].sellPc.toFixed(2)}`).join('\n');

  /* LOW COST tables (force lowest tier) */
  const lowLines=(side)=>quantities.map(q=>{
    const p=baseParams(q);
    p.printOverride=RATES.LOWEST_PRINT[side==='one'?'1':'2'];
    return `${q.toLocaleString().padEnd(7,' ')} ........... $${compute(p)[side].sellPc.toFixed(2)}`;
  }).join('\n');

  /* UI */
  return(
    <div className="grid md:grid-cols-2 gap-8">
      {/* ===== COSTING ===== */}
      <div className="space-y-6">
        <h1 className="text-2xl font-bold">Custom Costing</h1>

        {/* Quantities */}
        <section className="bg-white p-4 rounded-xl shadow space-y-3">
          <h2 className="font-semibold">Order Quantities</h2>
          <div className="flex flex-wrap gap-2">
            {RATES.QTY_PRESETS.map(b=><button key={b} className="px-3 py-1 bg-slate-200 rounded hover:bg-slate-300" onClick={()=>setQuantities(q=>q.includes(b)?q:[...q,b].sort((a,b)=>a-b))}>{b.toLocaleString()}</button>)}
          </div>
          <div className="flex gap-2">
            <Num value={customQty} onChange={e=>setCustomQty(e.target.value)}/>
            <button className="px-3 py-1 bg-indigo-500 text-white rounded" onClick={()=>{if(customQty){setQuantities(q=>[...q,+customQty].sort((a,b)=>a-b));setCustomQty('')}}}>Add</button>
          </div>
        </section>

        {/* Layout */}
        <section className="bg-white p-4 rounded-xl shadow">
          <h2 className="font-semibold mb-2">Piece layout</h2>
          <div className="grid grid-cols-2 gap-4">
            <Label>UP<Num value={UP} onChange={e=>setUP(e.target.value)}/></Label>
            <Label>OUT<Num value={OUT} onChange={e=>setOUT(e.target.value)}/></Label>
          </div>
        </section>

        {/* Paper */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <h2 className="font-semibold">Paper</h2>
          <select className="w-full border rounded px-2 py-1" value={paperIdx} onChange={e=>setPaperIdx(+e.target.value)}>
            {papers.map((p,i)=><option key={p.id} value={i}>{p.label}</option>)}
          </select>
          <label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={paperAtCost} onChange={e=>setPaperAtCost(e.target.checked)}/>Add paper at cost (exclude markup)</label>
        </section>

        {/* Printing */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <label className="flex items-center gap-2 font-semibold"><input type="checkbox" checked={includePrint} onChange={e=>setIncludePrint(e.target.checked)}/>Include printing</label>
          {includePrint&&<Label>Override cost / Press-Sheet <Num value={printOverride} onChange={e=>setPrintOverride(e.target.value)}/></Label>}
        </section>

        {/* Die */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <label className="flex items-center gap-2 font-semibold"><input type="checkbox" checked={includeDie} onChange={e=>setIncludeDie(e.target.checked)}/>Include die-cutting</label>
          {includeDie&&<>
            <Label>Machine
              <select className="border rounded px-2 py-1" value={dieMachine} onChange={e=>setDieMachine(e.target.value)}>
                {Object.entries(RATES.DIE_MACHINES).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
              </select>
            </Label>
            <Label>Custom setup $/job<Num value={dieSetupOverride} onChange={e=>setDieSetupOverride(e.target.value)}/></Label>
            <Label>Custom action $/pc<Num value={dieActionOverride} onChange={e=>setDieActionOverride(e.target.value)}/></Label>
            <Label>Windows / piece<Num value={windows} min={0} onChange={e=>setWindows(e.target.value)}/></Label>
          </>}
        </section>

        {/* Glue */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <label className="flex items-center gap-2 font-semibold"><input type="checkbox" checked={glueInclude} onChange={e=>setGlueInclude(e.target.checked)}/>Include glue</label>
          {glueInclude&&<>
            <Label>Machine
              <select className="border rounded px-2 py-1" value={glueMachine} onChange={e=>{setGlueMachine(e.target.value);setGlueMode(Object.keys(RATES.GLUE_MACHINES[e.target.value].rates)[0])}}>
                {Object.entries(RATES.GLUE_MACHINES).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}
              </select>
            </Label>
            <Label>Mode / rate
              <select className="border rounded px-2 py-1" value={glueMode} onChange={e=>setGlueMode(e.target.value)}>
                {Object.entries(RATES.GLUE_MACHINES[glueMachine].rates).map(([m,r])=><option key={m} value={m}>{m} – ${r.toFixed(2)}/pc</option>)}
              </select>
            </Label>
            {glueMachine==='HAND'&&<label className="inline-flex items-center gap-2 text-sm"><input type="checkbox" checked={glueAtCost} onChange={e=>setGlueAtCost(e.target.checked)}/>Add glue at cost (first $0.04 in markup)</label>}
          </>}
        </section>

        {/* Pre-press */}
        <section className="bg-white p-4 rounded-xl shadow space-y-1">
          <h2 className="font-semibold">Pre-press / proofing</h2>
          <Label># of SKUs<Num value={SKUs} min={1} onChange={e=>setSKUs(e.target.value)}/></Label>
          <p className="text-xs text-slate-500">Cost = Base $65 + $35 per extra SKU (after markup, always included)</p>
        </section>

        {/* Margin */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <label className="flex items-center gap-2 font-semibold"><input type="checkbox" checked={useMargin} onChange={e=>setUseMargin(e.target.checked)}/>Include margin</label>
          {useMargin&&<>
            <select className="w-full border rounded px-2 py-1" value={marginPreset} onChange={e=>setMarginPreset(e.target.value)}>
              {RATES.MARGINS.map(m=><option key={m} value={m}>{(m*100).toFixed(0)}%</option>)}
            </select>
            <Label>Custom %<Num value={marginCustom} onChange={e=>setMarginCustom(e.target.value)}/></Label>
          </>}
        </section>

        {/* Handling */}
        <section className="bg-white p-4 rounded-xl shadow space-y-2">
          <label className="flex items-center gap-2 font-semibold"><input type="checkbox" checked={includeHandling} onChange={e=>setIncludeHandling(e.target.checked)}/>Include handling</label>
          {includeHandling&&<Label>Cost / piece<Num value={handleOverride} onChange={e=>setHandleOverride(e.target.value)}/></Label>}
          <p className="text-xs text-slate-500">Default $0.02 / pc when OUT ≤ 5</p>
        </section>
      </div>

      {/* ===== PRICING ===== */}
      <div className="space-y-6">
        <h1 className="text-2xl font-bold">Custom Pricing</h1>

        {quantities.map(q=>{
          const res=compute(baseParams(q));
          const {one,two,addOn,costBreak}= {...res.one, addOn:res.addOn};
          return(
            <motion.div key={q} className="bg-white p-6 rounded-xl shadow space-y-2" initial={{opacity:0,y:20}} animate={{opacity:1,y:0}}>
              <h3 className="text-lg font-semibold">{q.toLocaleString()} pcs</h3>
              <table className="w-full text-sm mb-1">
                <thead><tr className="text-left"><th></th><th>$ / pc</th><th>Total</th></tr></thead>
                <tbody>
                  <tr><td>1-Sided</td><td>${res.one.sellPc.toFixed(2)}</td><td>${res.one.sellTotal.toFixed(2)}</td></tr>
                  <tr><td>2-Sided</td><td>${res.two.sellPc.toFixed(2)}</td><td>${res.two.sellTotal.toFixed(2)}</td></tr>
                </tbody>
              </table>
              <p className="text-sm">2-Sided add-on: +${addOn.toFixed(2)} / pc</p>
              <p className="text-xs text-slate-500">Press-sheets incl. overage: {res.pressSheets}</p>
              <p className="text-xs text-slate-500">Costs / pc: Paper ${res.one.costBreak.paper.toFixed(4)} + Print ${res.one.costBreak.print.toFixed(4)} + Die ${res.one.costBreak.die.toFixed(4)} + Strip ${res.one.costBreak.strip.toFixed(4)} + Glue ${res.one.costBreak.glue.toFixed(4)} + Pre ${res.one.costBreak.pre.toFixed(4)} + Handling ${res.one.costBreak.handling.toFixed(4)} = ${(Object.values(res.one.costBreak).reduce((a,b)=>a+b,0)).toFixed(4)}</p>
            </motion.div>
          );
        })}

        {/* COPY BLOCKS */}
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <h2 className="font-semibold mb-1">Pricing table 1-Sided</h2>
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:fmtLines('one').replace(/\n/g,'<br/>')}}></div>
          </div>
          <div>
            <h2 className="font-semibold mb-1">Pricing table 2-Sided</h2>
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:fmtLines('two').replace(/\n/g,'<br/>')}}></div>
          </div>
        </div>

        {/* BEST-PRICE */}
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <h2 className="font-semibold mb-1">Best-price quantities 1-Sided</h2>
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:bestLines('one').replace(/\n/g,'<br/>')}}></div>
          </div>
          <div>
            <h2 className="font-semibold mb-1">Best-price quantities 2-Sided</h2>
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:bestLines('two').replace(/\n/g,'<br/>')}}></div>
          </div>
        </div>

        {/* LOW COST */}
        <div>
          <h2 className="font-semibold mb-1">Low Cost Printing Pricing</h2>
          <div className="grid md:grid-cols-2 gap-4">
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:lowLines('one').replace(/\n/g,'<br/>')}}></div>
            <div contenteditable className="whitespace-pre font-mono border rounded p-2 bg-white shadow" dangerouslySetInnerHTML={{__html:lowLines('two').replace(/\n/g,'<br/>')}}></div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ===== MOUNT ===== */
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>

  <!-- ===================================================
    // Edit RATES to tweak tiers, machines, or low-cost values.
    // Core math lives in compute(); best-break logic in bestBreaks().
  =================================================== -->
</body>
</html>
